<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>SHEIN Smart Watcher</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">

<style>
body { font-family: Arial; background:#f2f2f2; padding:10px }
h2 { text-align:center }
button {
  width:100%; padding:14px; margin:6px 0;
  font-size:16px; background:black; color:white; border:none;
}
.card {
  background:white; padding:10px; margin-top:8px;
  border-radius:6px;
}
.small { font-size:13px; color:#555 }
.badge { font-size:12px; background:#eee; padding:4px }
</style>
</head>

<body>

<h2>SHEIN Smart Watcher</h2>

<button onclick="setGender('MEN')">ðŸ‘• MALE PRODUCTS</button>
<button onclick="setGender('WOMEN')">ðŸ‘— WOMEN PRODUCTS</button>
<button onclick="toggle()">â–¶ START / STOP SCAN</button>

<div id="status" class="card">Idle</div>
<div id="result"></div>

<audio id="beep">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">
</audio>

<script>
/* ================= SETTINGS ================= */
const BASE_SIZES = ["XL","L","28","30","32"];
const PINCODE = "248001";

/* ================= STATE ================= */
let running = false;
let interval = null;
let foundOnce = false;
let gender = "MEN";

/* ================= PERMISSIONS ================= */
if ("Notification" in window) Notification.requestPermission();

/* ================= GENDER ================= */
function setGender(g) {
  gender = g;
  document.getElementById("status").innerText =
    g + " selected | Pincode " + PINCODE;
}

/* ================= SIZE FALLBACK ================= */
function sizeVariants(size) {
  const order = ["XS","S","M","L","XL","XXL"];
  if (order.includes(size)) {
    let i = order.indexOf(size);
    return [size, order[i-1], order[i+1]].filter(Boolean);
  }
  if (!isNaN(size)) {
    let n = parseInt(size);
    return [n, n-2, n+2].map(String);
  }
  return [size];
}

/* ================= TOGGLE ================= */
function toggle() {
  if (running) {
    clearInterval(interval);
    running = false;
    document.getElementById("status").innerText = "Stopped";
  } else {
    foundOnce = false;
    interval = setInterval(scan, 1000);
    running = true;
    document.getElementById("status").innerText =
      "Scanning " + gender + " productsâ€¦";
  }
}

/* ================= SCAN ================= */
function scan() {
  if (!navigator.onLine) {
    document.getElementById("status").innerText =
      "Offline â€“ waiting for internet";
    return;
  }

  let links = document.querySelectorAll("a");
  let results = [];

  links.forEach(a => {
    let text = a.innerText.toUpperCase();

    if (
      text.includes("OUT OF STOCK") ||
      text.includes("SOLD OUT")
    ) return;

    if (!text.includes(gender)) return;

    let sizeOk = false;
    BASE_SIZES.forEach(s => {
      sizeVariants(s).forEach(v => {
        if (text.includes(v)) sizeOk = true;
      });
    });
    if (!sizeOk) return;

    let price = text.match(/â‚¹\s?(\d+)/);
    let id = a.href.match(/\d+/);
    if (!price || !id) return;

    results.push({
      id: id[0],
      price: price[1],
      text: text.substring(0,80)
    });
  });

  if (results.length) {
    clearInterval(interval);
    running = false;
    notify(results);
  } else {
    document.getElementById("status").innerText =
      "No " + gender + " product found yetâ€¦";
  }
}

/* ================= NOTIFY + UI ================= */
function notify(items) {
  document.getElementById("beep").play();
  if (navigator.vibrate) navigator.vibrate([300,200,300]);

  if (Notification.permission === "granted") {
    new Notification(gender + " product found", {
      body: items.length + " item(s) matched"
    });
  }

  let html = `<div class="card"><b>${gender} PRODUCTS</b><br>
              <span class="badge">Check delivery to ${PINCODE}</span></div>`;

  items.forEach(i => {
    html += `
      <div class="card">
        <div class="small">${i.text}â€¦</div>
        <button onclick="openShein('${i.id}')">
          â‚¹${i.price} â†’ OPEN IN SHEIN
        </button>
      </div>`;
  });

  document.getElementById("result").innerHTML = html;
  document.getElementById("status").innerText =
    gender + " product(s) found";
}

function openShein(id) {
  window.location.href = "shein://product/" + id;
}
</script>

<!-- ================= PWA ================= -->
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
