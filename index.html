<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>WB Business Sender</title>
<meta name="theme-color" content="#1e88e5" />
<style>
  /* (same styles as before, omitted for brevity) */
  :root {
    --bg: #f9fafb;
    --primary: #1e88e5;
    --text: #222;
    --muted: #666;
    --card-bg: #fff;
    --border: #ddd;
    --danger: #e53935;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0; padding: 12px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
      Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    background: var(--bg);
    color: var(--text);
  }
  .app {
    max-width: 720px;
    margin: 0 auto;
  }
  h1 {
    font-weight: 600;
    margin-bottom: 10px;
    color: var(--primary);
    text-align: center;
  }
  section {
    background: var(--card-bg);
    border-radius: 10px;
    box-shadow: 0 3px 7px rgb(30 136 229 / 0.15);
    padding: 15px 20px;
    margin-bottom: 16px;
  }
  label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
    color: var(--muted);
  }
  input[type="text"], input[type="number"], textarea {
    width: 100%;
    padding: 10px;
    font-size: 15px;
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 12px;
    resize: vertical;
  }
  textarea {
    min-height: 80px;
  }
  button {
    background: var(--primary);
    border: none;
    padding: 12px 18px;
    color: white;
    border-radius: 8px;
    font-size: 15px;
    cursor: pointer;
    user-select: none;
    transition: background 0.3s ease;
  }
  button:hover {
    background: #1565c0;
  }
  button.ghost {
    background: transparent;
    color: var(--primary);
    border: 1.5px solid var(--primary);
  }
  button.ghost:hover {
    background: var(--primary);
    color: white;
  }
  .row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
  }
  .row > * {
    flex: 1;
  }
  .row > button {
    flex: 0 0 auto;
    min-width: 120px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }
  th, td {
    padding: 8px 6px;
    border-bottom: 1px solid var(--border);
    font-size: 14px;
  }
  th {
    text-align: left;
    color: var(--muted);
  }
  td input[type="text"] {
    width: 100%;
    font-size: 14px;
    padding: 6px 8px;
    margin: 0;
  }
  .checkbox-col {
    width: 32px;
    text-align: center;
  }
  #status {
    margin-top: 12px;
    color: var(--primary);
    font-weight: 600;
    text-align: center;
  }
</style>
</head>
<body>
<div class="app" role="main" aria-label="WhatsApp Business Sender app">
  <h1>WB Business Sender</h1>

  <section aria-label="Contacts section">
    <label for="fileInput">Import Contacts from Broadcast ZIP or TXT/CSV</label>
    <div class="row">
      <input id="fileInput" type="file" accept=".zip,.txt,.csv" aria-describedby="fileHelp" />
      <button id="importBtn" type="button">Import</button>
    </div>
    <small id="fileHelp" style="display:block;margin-top:-10px;margin-bottom:10px;color:#555;font-size:13px;">
      Upload WhatsApp Business broadcast export (.zip with .txt inside) or text list
    </small>

    <label for="manualNumbers">Paste or Enter Numbers (one per line)</label>
    <div class="row">
      <textarea id="manualNumbers" placeholder="e.g. 919876543210" rows="3"></textarea>
      <button id="pasteBtn" type="button">Add</button>
    </div>

    <label for="customNumber">Add Custom Number</label>
    <div class="row" style="margin-bottom:12px;">
      <input id="customNumber" type="text" placeholder="Phone number (with country code)" aria-label="Custom phone number" />
      <input id="customName" type="text" placeholder="Name (optional)" aria-label="Custom contact name" />
      <button id="addCustom" type="button">Add</button>
    </div>

    <label>Contacts List</label>
    <table aria-label="Contacts list" id="contactsTable" role="grid">
      <thead>
        <tr>
          <th class="checkbox-col"><input id="selectAll" type="checkbox" aria-label="Select all contacts" /></th>
          <th>Name</th>
          <th>Phone Number</th>
          <th>Edit Message</th>
          <th>Remove</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section aria-label="Message section">
    <label for="defaultMsg">Default Message (can use {{name}} for personalization)</label>
    <textarea id="defaultMsg" rows="4" placeholder="Enter message here..."></textarea>
  </section>

  <section aria-label="Send controls" style="text-align:center;">
    <button id="prepareBtn" type="button">Prepare Messages</button>
    <button id="sendAll" type="button" disabled>Send All</button>
    <button id="exportSent" type="button">Export Sent Numbers</button>
  </section>

  <div id="status" role="status" aria-live="polite"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script>
(() => {
  const $ = id => document.getElementById(id);
  const sleep = ms => new Promise(res => setTimeout(res, ms));
  const normPhone = s => (s || '').replace(/[^0-9+]/g, '');
  const esc = s => ('' + s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  let contacts = [];
  let prepared = [];
  let sentPhones = JSON.parse(localStorage.getItem('wb_sent')||'[]');
  let sendIndex = 0;
  let sendingActive = false;
  const contactsTbody = $('contactsTable').querySelector('tbody');
  const statusEl = $('status');
  const sendAllBtn = $('sendAll');

  function renderContacts(){
    contactsTbody.innerHTML = '';
    contacts.forEach((c,i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="checkbox-col"><input type="checkbox" data-idx="${i}" class="sel" ${c.selected ? 'checked' : ''} aria-label="Select contact ${esc(c.name || c.phone)}"></td>
        <td>${esc(c.name || '')}</td>
        <td>${esc(c.phone)}</td>
        <td><input type="text" data-idx="${i}" class="msgEdit" value="${esc(c.message || '')}" aria-label="Edit message for ${esc(c.name || c.phone)}"></td>
        <td><button data-idx="${i}" class="removeBtn" aria-label="Remove contact ${esc(c.name || c.phone)}" style="background:#e53935;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">X</button></td>
      `;
      contactsTbody.appendChild(tr);
    });
  }

  function addContact(phone,name=''){
    const cleanPhone = normPhone(phone);
    if(!cleanPhone || cleanPhone.length < 6) return false;
    if(contacts.find(c => normPhone(c.phone) === cleanPhone)) return false;
    contacts.push({phone: cleanPhone, name: name.trim(), message: '', selected:true});
    renderContacts();
    return true;
  }

  contactsTbody.addEventListener('click', e => {
    if(e.target.classList.contains('removeBtn')){
      const i = Number(e.target.dataset.idx);
      contacts.splice(i,1);
      renderContacts();
    }
  });

  contactsTbody.addEventListener('change', e => {
    if(e.target.classList.contains('sel')){
      const i = Number(e.target.dataset.idx);
      contacts[i].selected = e.target.checked;
    }
  });

  contactsTbody.addEventListener('input', e => {
    if(e.target.classList.contains('msgEdit')){
      const i = Number(e.target.dataset.idx);
      contacts[i].message = e.target.value;
    }
  });

  $('selectAll').addEventListener('change', e => {
    contacts.forEach(c => c.selected = e.target.checked);
    renderContacts();
  });

  $('pasteBtn').addEventListener('click', () => {
    const lines = $('manualNumbers').value.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
    let added = 0;
    lines.forEach(l => { if(addContact(l)) added++; });
    alert(`Added ${added} contacts`);
    $('manualNumbers').value = '';
  });

  $('addCustom').addEventListener('click', () => {
    const phone = $('customNumber').value.trim();
    const name = $('customName').value.trim();
    if(addContact(phone, name)) {
      $('customNumber').value = '';
      $('customName').value = '';
    } else alert('Invalid or duplicate phone number');
  });

  $('importBtn').addEventListener('click', async () => {
    const f = $('fileInput').files[0];
    if(!f) return alert('Select a file first');
    try {
      const name = f.name.toLowerCase();
      if(name.endsWith('.zip')){
        const ab = await f.arrayBuffer();
        const zip = await JSZip.loadAsync(ab);
        const txtFiles = Object.keys(zip.files).filter(k => 
          (k.toLowerCase().endsWith('.txt') || k.toLowerCase().endsWith('.csv')) && !zip.files[k].dir
        );
        if(txtFiles.length === 0) return alert('No .txt or .csv file found inside the zip');
        const text = await zip.file(txtFiles[0]).async('string');
        importFromText(text);
      } else {
        const text = await f.text();
        importFromText(text);
      }
    } catch(e) {
      alert('Import failed: ' + e.message);
    }
  });

  function importFromText(text){
    const lines = text.split(/\r?\n/);
    let added = 0;
    lines.forEach(line => {
      const m = line.match(/(\+?\d{6,})/);
      if(m){
        if(addContact(m[0])) added++;
      }
    });
    alert(`Imported ${added} contacts`);
  }

  $('prepareBtn').addEventListener('click', () => {
    const defaultMsg = $('defaultMsg').value || '';
    prepared = contacts
      .filter(c => c.selected && normPhone(c.phone).length > 6)
      .map(c => ({
        phone: normPhone(c.phone),
        name: c.name,
        text: c.message.trim() || defaultMsg.replace(/{{\s*name\s*}}/gi, c.name || '')
      }));
    if(prepared.length === 0){
      alert('No valid selected contacts to send');
      sendAllBtn.disabled = true;
      return;
    }
    sendAllBtn.disabled = false;
    alert(`Prepared ${prepared.length} messages.`);
  });

  $('exportSent').addEventListener('click', () => {
    if(sentPhones.length === 0){
      alert('No sent numbers to export.');
      return;
    }
    const blob = new Blob([sentPhones.join('\n')], {type:'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'sent_numbers.txt';
    a.click();
    URL.revokeObjectURL(url);
  });

  async function sendNext(){
    if(sendIndex >= prepared.length){
      sendingActive = false;
      statusEl.textContent = 'All messages sent.';
      return;
    }
    const c = prepared[sendIndex];
    statusEl.textContent = `Sending to ${c.phone} (${sendIndex + 1} / ${prepared.length})...`;

    const encodedText = encodeURIComponent(c.text);
    const url = `whatsapp://send?phone=${c.phone}&text=${encodedText}`;

    // Open WhatsApp Business chat by trying the whatsapp:// scheme (usually opens WhatsApp Business if installed)
    // Note: On some devices, whatsapp:// opens regular WhatsApp if both are installed.
    // There's no reliable way from a browser to force opening WhatsApp Business only.
    // You can instruct users to set WhatsApp Business as default for whatsapp:// links.
    window.location.href = url;

    sentPhones.push(c.phone);
    localStorage.setItem('wb_sent', JSON.stringify(sentPhones));

    sendIndex++;
  }

  window.addEventListener('focus', async () => {
    if(!sendingActive) return;
    await sleep(1000);
    await sendNext();
  });

  $('sendAll').addEventListener('click', async () => {
    if(prepared.length === 0){
      alert('Prepare messages first.');
      return;
    }
    sendingActive = true;
    sendIndex = 0;
    await sendNext();
  });

  renderContacts();
})();
</script>
</body>
</html>
    border-bottom: 1px solid var(--border);
    font-size: 14px;
  }
  th {
    text-align: left;
    color: var(--muted);
  }
  td input[type="text"] {
    width: 100%;
    font-size: 14px;
    padding: 6px 8px;
    margin: 0;
  }
  .checkbox-col {
    width: 32px;
    text-align: center;
  }
  .attachment-item {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
  }
  .attachment-item img {
    max-width: 60px;
    max-height: 60px;
    border-radius: 6px;
    object-fit: contain;
    border: 1px solid var(--border);
  }
  .attachment-item > div {
    flex: 1;
  }
  .attachment-item button {
    flex-shrink: 0;
    padding: 6px 12px;
    font-size: 13px;
  }
  #previewArea {
    max-height: 220px;
    overflow-y: auto;
    background: #e3f2fd;
    border-radius: 8px;
    padding: 10px;
    font-family: monospace;
    white-space: pre-wrap;
    margin-bottom: 10px;
  }
  footer {
    text-align: center;
    font-size: 13px;
    color: var(--muted);
    margin-top: 10px;
  }
  /* PWA install banner styles if needed */
</style>
</head>
<body>
<div class="app" role="main" aria-label="WhatsApp Business Sender app">
  <h1>WB Business Sender</h1>

  <!-- Contacts Section -->
  <section aria-label="Contacts section">
    <label for="fileInput">Import Contacts from Broadcast ZIP or TXT/CSV</label>
    <div class="row">
      <input id="fileInput" type="file" accept=".zip,.txt,.csv" aria-describedby="fileHelp" />
      <button id="importBtn" type="button">Import</button>
    </div>
    <small id="fileHelp" style="display:block;margin-top:-10px;margin-bottom:10px;color:#555;font-size:13px;">
      Upload WhatsApp Business broadcast export (.zip with .txt inside) or text list
    </small>

    <label for="manualNumbers">Paste or Enter Numbers (one per line)</label>
    <div class="row">
      <textarea id="manualNumbers" placeholder="e.g. 919876543210" rows="3"></textarea>
      <button id="pasteBtn" type="button">Add</button>
    </div>

    <label for="customNumber">Add Custom Number</label>
    <div class="row" style="margin-bottom:12px;">
      <input id="customNumber" type="text" placeholder="Phone number (with country code)" aria-label="Custom phone number" />
      <input id="customName" type="text" placeholder="Name (optional)" aria-label="Custom contact name" />
      <button id="addCustom" type="button">Add</button>
    </div>

    <label>Contacts List</label>
    <table aria-label="Contacts list" id="contactsTable" role="grid">
      <thead>
        <tr>
          <th class="checkbox-col"><input id="selectAll" type="checkbox" aria-label="Select all contacts" /></th>
          <th>Name</th>
          <th>Phone Number</th>
          <th>Edit Message</th>
          <th>Remove</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Message Section -->
  <section aria-label="Message section">
    <label for="defaultMsg">Default Message (can use {{name}} for personalization)</label>
    <textarea id="defaultMsg" rows="4" placeholder="Enter message here..."></textarea>
  </section>

  <!-- Attachments Section -->
  <section aria-label="Attachments section">
    <label for="attachFileInput">Upload Attachments</label>
    <input id="attachFileInput" type="file" multiple aria-describedby="attachHelp" />
    <small id="attachHelp" style="display:block;margin-top:6px;margin-bottom:12px;color:#555;font-size:13px;">
      Upload multiple images or files. Download or use attachment hint when sending.
    </small>
    <div id="attachmentList" aria-live="polite" aria-relevant="additions"></div>
  </section>

  <!-- Controls Section -->
  <section aria-label="Send controls" style="text-align:center;">
    <button id="prepareBtn" type="button">Prepare Messages</button>
    <button id="sendAll" type="button" disabled>Send All</button>
    <button id="exportSent" type="button">Export Sent Numbers</button>
  </section>

  <div id="status" role="status" aria-live="polite" style="margin-top:12px;color:#1e88e5;font-weight:600;text-align:center;"></div>

</div>

<!-- JSZip -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
(() => {
  // Helpers
  const $ = id => document.getElementById(id);
  const sleep = ms => new Promise(res => setTimeout(res, ms));
  const normPhone = s => (s || '').replace(/[^0-9+]/g, '');
  const esc = s => ('' + s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  // State
  let contacts = []; // {phone,name,message,selected}
  let attachments = []; // {id,name,dataUrl}
  let prepared = [];
  let sentPhones = JSON.parse(localStorage.getItem('wb_sent')||'[]');
  let controllerWindow = null;
  let sendIndex = 0;
  let sendingActive = false;
  let delayMs = 1000;

  // UI Elements
  const contactsTbody = $('contactsTable').querySelector('tbody');
  const statusEl = $('status');
  const sendAllBtn = $('sendAll');

  // Render contacts list
  function renderContacts(){
    contactsTbody.innerHTML = '';
    contacts.forEach((c,i) => {
      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td class="checkbox-col"><input type="checkbox" data-idx="${i}" class="sel" ${c.selected ? 'checked' : ''} aria-label="Select contact ${esc(c.name || c.phone)}"></td>
        <td>${esc(c.name || '')}</td>
        <td>${esc(c.phone)}</td>
        <td><input type="text" data-idx="${i}" class="msgEdit" value="${esc(c.message || '')}" aria-label="Edit message for ${esc(c.name || c.phone)}"></td>
        <td><button data-idx="${i}" class="removeBtn" aria-label="Remove contact ${esc(c.name || c.phone)}" style="background:#e53935;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">X</button></td>
      `;
      contactsTbody.appendChild(tr);
    });
  }

  // Add new contact
  function addContact(phone,name=''){
    const cleanPhone = normPhone(phone);
    if(!cleanPhone || cleanPhone.length < 6) return false;
    if(contacts.find(c => normPhone(c.phone) === cleanPhone)) return false;
    contacts.push({phone: cleanPhone, name: name.trim(), message: '' , selected:true});
    renderContacts();
    return true;
  }

  // Remove contact
  contactsTbody.addEventListener('click', e => {
    if(e.target.classList.contains('removeBtn')){
      const i = Number(e.target.dataset.idx);
      contacts.splice(i,1);
      renderContacts();
    }
  });

  // Select/deselect contact
  contactsTbody.addEventListener('change', e => {
    if(e.target.classList.contains('sel')){
      const i = Number(e.target.dataset.idx);
      contacts[i].selected = e.target.checked;
    }
  });

  // Edit message per contact
  contactsTbody.addEventListener('input', e => {
    if(e.target.classList.contains('msgEdit')){
      const i = Number(e.target.dataset.idx);
      contacts[i].message = e.target.value;
    }
  });

  // Select all checkbox
  $('selectAll').addEventListener('change', e => {
    contacts.forEach(c => c.selected = e.target.checked);
    renderContacts();
  });

  // Import contacts from pasted numbers
  $('pasteBtn').addEventListener('click', () => {
    const lines = $('manualNumbers').value.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
    let added = 0;
    lines.forEach(l => { if(addContact(l)) added++; });
    alert(`Added ${added} contacts`);
    $('manualNumbers').value = '';
  });

  // Add custom number and name
  $('addCustom').addEventListener('click', () => {
    const phone = $('customNumber').value.trim();
    const name = $('customName').value.trim();
    if(addContact(phone, name)) {
      $('customNumber').value = '';
      $('customName').value = '';
    } else alert('Invalid or duplicate phone number');
  });

  // Import contacts from file (ZIP/TXT/CSV)
  $('importBtn').addEventListener('click', async () => {
    const f = $('fileInput').files[0];
    if(!f) return alert('Select a file first');
    try {
      const name = f.name.toLowerCase();
      if(name.endsWith('.zip')){
        const ab = await f.arrayBuffer();
        const zip = await JSZip.loadAsync(ab);
        const txtKey = Object.keys(zip.files).find(k=>k.toLowerCase().endsWith('.txt') || k.toLowerCase().endsWith('.csv'));
        if(!txtKey) return alert('No .txt or .csv file found inside the zip');
        const text = await zip.file(txtKey).async('string');
        importFromText(text);
      } else {
        const text = await f.text();
        importFromText(text);
      }
    } catch(e) {
      alert('Import failed: ' + e.message);
    }
  });

  function importFromText(text){
    const lines = text.split(/\r?\n/);
    let added = 0;
    lines.forEach(line => {
      const m = line.match(/([+0-9]{6,})/);
      if(m) if(addContact(m[0])) added++;
    });
    alert(`Imported ${added} contacts`);
  }

  // Attachments storage using IndexedDB
  let attachmentsList = [];

  function openDB(){
    return new Promise((res, rej) => {
      const req = indexedDB.open('wb_attachments', 1);
      req.onupgradeneeded = e => {
        const db = e.target.result;
        if(!db.objectStoreNames.contains('attachments')){
          db.createObjectStore('attachments', {keyPath:'id'});
        }
      };
      req.onsuccess = e => res(e.target.result);
      req.onerror = e => rej(e.target.error);
    });
  }

  async function saveAttachment(att){
    const db = await openDB();
    return new Promise((res, rej) => {
      const tx = db.transaction('attachments','readwrite');
      tx.objectStore('attachments').put(att);
      tx.oncomplete = () => res();
      tx.onerror = e => rej(e.target.error);
    });
  }

  async function loadAttachments(){
    const db = await openDB();
    return new Promise((res, rej) => {
      const tx = db.transaction('attachments','readonly');
      const req = tx.objectStore('attachments').getAll();
      req.onsuccess = e => res(e.target.result || []);
      req.onerror = e => rej(e.target.error);
    });
  }

  async function deleteAttachment(id){
    const db = await openDB();
    return new Promise((res, rej) => {
      const tx = db.transaction('attachments','readwrite');
      tx.objectStore('attachments').delete(id);
      tx.oncomplete = () => res();
      tx.onerror = e => rej(e.target.error);
    });
  }

  function renderAttachments(){
    const list = $('attachmentList');
    list.innerHTML = '';
    attachmentsList.forEach((att, i) => {
      const div = document.createElement('div');
      div.className = 'attachment-item';
      const isImg = att.dataUrl.startsWith('data:image');
      const preview = document.createElement(isImg ? 'img' : 'div');
      if(isImg) preview.src = att.dataUrl;
      else preview.textContent = att.name;
      preview.style.maxWidth = '60px';
      preview.style.maxHeight = '60px';
      preview.style.borderRadius = '6px';
      preview.style.objectFit = 'contain';

      const nameDiv = document.createElement('div');
      nameDiv.textContent = att.name;

      const useBtn = document.createElement('button');
      useBtn.textContent = 'Use Hint';
      useBtn.title = 'Set attachment hint for sending';
      useBtn.onclick = () => {
        $('attachHint').value = att.name;
        alert('Attachment hint set: ' + att.name);
      };

      const delBtn = document.createElement('button');
      delBtn.textContent = 'Delete';
      delBtn.style.backgroundColor = 'var(--danger)';
      delBtn.onclick = async () => {
        await deleteAttachment(att.id);
        attachmentsList = await loadAttachments();
        renderAttachments();
      };

      div.appendChild(preview);
      div.appendChild(nameDiv);
      div.appendChild(useBtn);
      div.appendChild(delBtn);
      list.appendChild(div);
    });
  }

  $('attachFileInput').addEventListener('change', async (e) => {
    const files = Array.from(e.target.files);
    for (const f of files) {
      const reader = new FileReader();
      reader.onload = async (ev) => {
        const id = 'att_' + Date.now() + Math.random().toString(36).slice(2);
        await saveAttachment({id, name: f.name, dataUrl: ev.target.result});
        attachmentsList = await loadAttachments();
        renderAttachments();
        alert('Saved attachment: ' + f.name);
      };
      reader.readAsDataURL(f);
    }
    e.target.value = ''; // clear input
  });

  // Message preparation
  $('prepareBtn').addEventListener('click', () => {
    const defaultMsg = $('defaultMsg').value || '';
    prepared = contacts
      .filter(c => c.selected && normPhone(c.phone).length > 6)
      .map(c => ({
        phone: normPhone(c.phone),
        name: c.name,
        text: c.message.trim() || defaultMsg.replace(/{{\s*name\s*}}/gi, c.name || '')
      }));
    if(prepared.length === 0){
      alert('No valid selected contacts to send');
      sendAllBtn.disabled = true;
      return;
    }
    sendAllBtn.disabled = false;
    alert(`Prepared ${prepared.length} messages.`);
  });

  // Export sent numbers
  $('exportSent').addEventListener('click', () => {
    if(sentPhones.length === 0){
      alert('No sent numbers to export.');
      return;
    }
    const blob = new Blob([sentPhones.join('\n')], {type:'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'sent_numbers.txt';
    a.click();
    URL.revokeObjectURL(url);
  });

  // Auto advance sending
  async function sendNext(){
    if(sendIndex >= prepared.length){
      sendingActive = false;
      statusEl.textContent = 'All messages sent.';
      return;
    }
    const c = prepared[sendIndex];
    statusEl.textContent = `Sending to ${c.phone} (${sendIndex + 1} / ${prepared.length})...`;

    // Build WhatsApp Business URI with text
    const encodedText = encodeURIComponent(c.text);
    // whatsapp://send?phone=919999999999&text=...
    const url = `whatsapp://send?phone=${c.phone}&text=${encodedText}`;

    // Open WhatsApp Business chat
    window.location.href = url;

    sentPhones.push(c.phone);
    localStorage.setItem('wb_sent', JSON.stringify(sentPhones));

    sendIndex++;
  }

  // Listen for focus to auto-send next
  window.addEventListener('focus', async () => {
    if(!sendingActive) return;
    await sleep(1000); // 1-second delay
    await sendNext();
  });

  // Start sending on button click
  $('sendAll').addEventListener('click', async () => {
    if(prepared.length === 0){
      alert('Prepare messages first.');
      return;
    }
    sendingActive = true;
    sendIndex = 0;
    await sendNext();
  });

  // Load attachments on start
  (async () => {
    attachmentsList = await loadAttachments();
    renderAttachments();
  })();

  // Add shortcut input for attach hint (optional)
  // You can expand this if you want to integrate attaching files with WhatsApp Business later

})();
</script>

<!-- PWA manifest and service worker registration -->
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(() => {
      // No SW or fallback
    });
  }
</script>
<link rel="manifest" href="manifest.json" />
</body>
</html>
