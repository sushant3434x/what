<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>SHEIN Smart Watcher</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#000000">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f2f2f2;
  padding: 10px;
}
h2 { text-align: center; }
button {
  width: 100%;
  padding: 14px;
  margin: 6px 0;
  font-size: 16px;
  background: black;
  color: white;
  border: none;
  border-radius: 6px;
}
.card {
  background: white;
  padding: 10px;
  margin-top: 8px;
  border-radius: 6px;
}
.small { font-size: 13px; color: #555; }
.badge {
  font-size: 12px;
  background: #eee;
  padding: 4px;
  display: inline-block;
  margin-top: 4px;
}
</style>
</head>

<body>

<h2>SHEIN Smart Watcher</h2>

<button onclick="toggle()">â–¶ START / STOP SCAN</button>
<button onclick="show('MEN')">ðŸ‘• SHOW MEN</button>
<button onclick="show('WOMEN')">ðŸ‘— SHOW WOMEN</button>

<div id="status" class="card">Idle</div>
<div id="result"></div>

<script>
/* ================= SETTINGS ================= */
const BASE_SIZES = ["XL","L","28","30","32"];
const PINCODE = "248001";

/* ================= STATE ================= */
let running = false;
let interval = null;
let scanCount = 0;

let found = {
  MEN: [],
  WOMEN: []
};

/* ================= PERMISSIONS ================= */
if ("Notification" in window) {
  Notification.requestPermission();
}

/* ================= SIZE FALLBACK ================= */
function sizeVariants(size) {
  const order = ["XS","S","M","L","XL","XXL"];
  if (order.includes(size)) {
    let i = order.indexOf(size);
    return [size, order[i-1], order[i+1]].filter(Boolean);
  }
  if (!isNaN(size)) {
    let n = parseInt(size);
    return [n, n-2, n+2].map(String);
  }
  return [size];
}

/* ================= TOGGLE ================= */
function toggle() {
  if (running) {
    clearInterval(interval);
    running = false;
    updateStatus("Stopped");
  } else {
    interval = setInterval(scan, 1000);
    running = true;
    updateStatus("Scanning men & womenâ€¦");
  }
}

/* ================= STATUS ================= */
function updateStatus(msg) {
  document.getElementById("status").innerText =
    msg + " | Cycles: " + scanCount;
}

/* ================= SCAN ================= */
function scan() {
  if (!navigator.onLine) {
    updateStatus("Offline â€“ waiting for internet");
    return;
  }

  scanCount++;
  updateStatus("Scanning men & womenâ€¦");

  let links = document.querySelectorAll("a");

  ["MEN","WOMEN"].forEach(gender => {
    links.forEach(a => {
      let text = a.innerText.toUpperCase();

      if (
        text.includes("OUT OF STOCK") ||
        text.includes("SOLD OUT")
      ) return;

      if (!text.includes(gender)) return;

      let sizeOk = false;
      BASE_SIZES.forEach(s =>
        sizeVariants(s).forEach(v => {
          if (text.includes(v)) sizeOk = true;
        })
      );
      if (!sizeOk) return;

      let priceMatch = text.match(/â‚¹\s?(\d+)/);
      let idMatch = a.href.match(/\d+/);
      if (!priceMatch || !idMatch) return;

      let id = idMatch[0];
      let price = parseInt(priceMatch[1]);

      if (found[gender].some(p => p.id === id)) return;

      found[gender].push({
        id, price, text: text.substring(0,80)
      });

      notify(gender);
    });
  });
}

/* ================= NOTIFY ================= */
function notify(gender) {
  let sound = gender === "MEN"
    ? "https://actions.google.com/sounds/v1/alarms/beep_short.ogg"
    : "https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg";

  new Audio(sound).play();
  if (navigator.vibrate) navigator.vibrate([200,100,200]);

  if (Notification.permission === "granted") {
    new Notification(gender + " product found", {
      body: "Tap to view results"
    });
  }
}

/* ================= PRICE GROUP ================= */
function groupByPrice(items) {
  return {
    under500: items.filter(p => p.price < 500),
    under1000: items.filter(p => p.price >= 500 && p.price < 1000),
    under4000: items.filter(p => p.price >= 1000 && p.price <= 4000)
  };
}

/* ================= SHOW ================= */
function show(gender) {
  let items = found[gender];
  if (!items.length) {
    document.getElementById("result").innerHTML =
      `<div class="card">No ${gender} products found yet</div>`;
    return;
  }

  let g = groupByPrice(items);
  let html = `
    <div class="card">
      <b>${gender} PRODUCTS</b><br>
      <span class="badge">Delivery checked in SHEIN (Pincode ${PINCODE})</span>
    </div>
  `;

  function render(title, list) {
    if (!list.length) return "";
    let h = `<div class="card"><b>${title}</b></div>`;
    list.forEach(i => {
      h += `
        <div class="card">
          <div class="small">${i.text}â€¦</div>
          <button onclick="openShein('${i.id}')">
            â‚¹${i.price} â†’ OPEN IN SHEIN
          </button>
        </div>`;
    });
    return h;
  }

  html += render("ðŸŸ¢ Under â‚¹500", g.under500);
  html += render("ðŸ”µ â‚¹500 â€“ â‚¹1000", g.under1000);
  html += render("ðŸŸ£ â‚¹1000 â€“ â‚¹4000", g.under4000);

  document.getElementById("result").innerHTML = html;
}

/* ================= OPEN SHEIN ================= */
function openShein(id) {
  window.location.href = "shein://product/" + id;
}
</script>

</body>
</html>
