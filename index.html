<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>SHEIN Instant Watcher</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">

<style>
body { font-family: Arial; background:#f2f2f2; padding:10px }
h2 { text-align:center }
button {
  width:100%; padding:14px; margin:6px 0;
  font-size:16px; background:black; color:white; border:none;
}
.card {
  background:white; padding:10px; margin-top:8px;
  border-radius:6px;
}
.counter { font-weight:bold }
</style>
</head>

<body>

<h2>SHEIN Instant Watcher</h2>

<button onclick="toggle()">START / STOP AUTO SCAN</button>

<div id="status" class="card">
  Waiting…
  <div id="counter" class="counter">Scans: 0</div>
</div>

<div id="result"></div>

<audio id="beep">
  <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg">
</audio>

<script>
/* ===== SETTINGS ===== */
const allowedSizes = ["XL","L","28","30","32"];
const PINCODE = "248001";

/* ===== STATE ===== */
let running = false;
let interval = null;
let foundOnce = false;
let scanCount = 0;

/* ===== PERMISSIONS ===== */
if ("Notification" in window) Notification.requestPermission();

/* ===== TOGGLE ===== */
function toggle() {
  if (running) {
    clearInterval(interval);
    running = false;
    document.getElementById("status").firstChild.textContent = "Stopped ";
  } else {
    foundOnce = false;
    scanCount = 0;
    updateCounter();
    interval = setInterval(scan, 1000);
    running = true;
    document.getElementById("status").firstChild.textContent =
      "Scanning every 1s | Pincode " + PINCODE + " ";
  }
}

/* ===== SCAN ===== */
function scan() {
  if (foundOnce) return;

  scanCount++;
  updateCounter();

  let links = document.querySelectorAll("a");
  let foundItem = null;

  links.forEach(a => {
    if (foundItem) return;

    let text = a.innerText.toUpperCase();

    if (
      text.includes("OUT OF STOCK") ||
      text.includes("SOLD OUT") ||
      text.includes("UNAVAILABLE")
    ) return;

    if (!text.includes("MEN")) return;
    if (!allowedSizes.some(s => text.includes(s))) return;

    let priceMatch = text.match(/₹\s?(\d+)/);
    let idMatch = a.href.match(/\d+/);
    if (!priceMatch || !idMatch) return;

    foundItem = { id: idMatch[0], price: priceMatch[1] };
  });

  if (foundItem) {
    foundOnce = true;
    clearInterval(interval);          // ⛔ AUTO STOP
    notify(foundItem);
  }
}

/* ===== UI ===== */
function updateCounter() {
  document.getElementById("counter").innerText = "Scans: " + scanCount;
}

function notify(item) {
  document.getElementById("beep").play();
  if (navigator.vibrate) navigator.vibrate([400,200,400]);

  document.getElementById("status").firstChild.textContent =
    "FOUND after " + scanCount + " scans ";

  document.getElementById("result").innerHTML = `
    <div class="card">
      <b>₹${item.price}</b><br>
      <button onclick="openShein('${item.id}')">
        OPEN IN SHEIN
      </button>
    </div>`;

  if (Notification.permission === "granted") {
    let n = new Notification("SHEIN PRODUCT FOUND", {
      body: "Tap to open product (₹" + item.price + ")",
      requireInteraction: true
    });
    n.onclick = () => window.focus();
  }

  // ✅ AUTO OPEN if app is already open
  setTimeout(() => {
    if (document.visibilityState === "visible") {
      openShein(item.id);
    }
  }, 800);
}

function openShein(id) {
  window.location.href = "shein://product/" + id;
}
</script>

<!-- ===== PWA ===== -->
<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("service-worker.js");
  });
}

let wakeLock = null;
async function keepAwake() {
  try {
    if ("wakeLock" in navigator) {
      wakeLock = await navigator.wakeLock.request("screen");
    }
  } catch {}
}
document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "visible") keepAwake();
});
keepAwake();
</script>

</body>
</html>
