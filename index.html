<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>WB Bulk Sender — PWA (with ZIP import)</title>
<meta name="theme-color" content="#071025">
<style>
  :root{--accent:#0b84ff;--bg:#071025;--card:#071425;--muted:#9aa4b2;--glass:rgba(255,255,255,0.02);font-family:Inter,system-ui,Segoe UI,Arial,sans-serif}
  *{box-sizing:border-box}
  body{margin:0;min-height:100vh;background:linear-gradient(180deg,#071025,#071425);color:#e6eef6;padding:14px;display:flex;align-items:flex-start;justify-content:center}
  .app{width:100%;max-width:980px;display:grid;grid-template-columns:1fr;gap:12px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .logo{font-weight:700;color:var(--accent);font-size:18px}
  .card{background:linear-gradient(180deg,var(--glass),rgba(255,255,255,0.01));padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  input,textarea,select,button{font:inherit}
  input,textarea,select{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:inherit;width:100%}
  textarea{min-height:90px;resize:vertical}
  .btn{background:var(--accent);color:#fff;border:0;padding:8px 10px;border-radius:8px;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
  .small{font-size:13px;color:var(--muted)}
  .muted{color:var(--muted)}
  .grid-2{display:grid;grid-template-columns:1fr 420px;gap:12px}
  @media(max-width:820px){.grid-2{grid-template-columns:1fr}}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:8px;border-bottom:1px dashed rgba(255,255,255,0.02);text-align:left}
  .checkbox-col{width:36px;text-align:center}
  .fab{position:fixed;right:18px;bottom:18px;background:var(--accent);color:#012;padding:12px;border-radius:12px;border:2px solid rgba(255,255,255,0.06);cursor:pointer;z-index:999}
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:1000}
  .modal .panel{width:94%;max-width:900px;background:#071425;padding:12px;border-radius:12px}
  .attachment-list img{max-width:80px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
  .countdown{display:inline-block;background:rgba(255,255,255,0.02);padding:6px 10px;border-radius:8px}
  .controls{display:flex;gap:8px;align-items:center}
  .notice{padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-top:8px}
</style>
</head>
<body>
<div class="app" role="application" aria-label="WB Bulk Sender PWA - single file">

  <header>
    <div>
      <div class="logo">WB Bulk Sender — PWA (ZIP import)</div>
      <div class="small muted">Installable single-file PWA • One-by-one auto-advance • ZIP import for Broadcast export</div>
    </div>
    <div class="controls">
      <div class="small muted">Countdown (One-by-One): <span id="cfgCountdown">3</span>s</div>
    </div>
  </header>

  <!-- Campaign editor -->
  <section class="card">
    <div class="row" style="align-items:center">
      <div style="flex:1">
        <input id="campName" placeholder="Campaign name (e.g., Promo May)" />
      </div>
      <div style="width:180px">
        <select id="viewSelector">
          <option value="campaign">Campaign</option>
          <option value="import">Import</option>
          <option value="attachments">Attachments</option>
          <option value="settings">Settings</option>
        </select>
      </div>
      <div style="width:120px"><button id="saveCampaign" class="btn">Save</button></div>
    </div>

    <div style="height:10px"></div>
    <textarea id="campMessage" placeholder="Message template. Use {{name}} for personalization."></textarea>

    <div style="height:10px"></div>
    <div class="row" style="align-items:center">
      <input id="attachHint" placeholder="Attachment name (choose from Attachments tab)" />
      <div style="flex:1"></div>
      <div class="small muted">Saved locally</div>
    </div>

    <div style="height:10px"></div>
    <div class="row">
      <button id="prepareSend" class="btn">Prepare Send</button>
      <button id="previewBtn" class="btn ghost">Preview</button>
    </div>
  </section>

  <!-- Main grid: import & contacts -->
  <div class="grid-2">

    <!-- Left: contacts & templates -->
    <div>

      <!-- Contacts card -->
      <section class="card" id="contactsPanel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Contacts</strong><div class="small muted">Select recipients</div></div>
          <div class="row">
            <button id="addSample" class="btn ghost">Add Sample</button>
            <button id="clearAll" class="btn ghost">Clear</button>
          </div>
        </div>

        <div style="height:8px"></div>

        <div style="display:flex;gap:8px">
          <input id="fileInput" type="file" accept=".csv,.vcf,.txt,.zip" />
          <button id="importBtn" class="btn">Import</button>
          <button id="parseBroadcastBtn" class="btn ghost">Paste Broadcast Text</button>
        </div>

        <div style="height:8px"></div>
        <div style="max-height:300px;overflow:auto">
          <table id="contactsTable">
            <thead><tr><th class="checkbox-col"><input id="selectAll" type="checkbox" /></th><th>Phone</th><th>Name</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="notice small muted">Tip: For Broadcast lists exported by WhatsApp Business choose the `.zip` exported file. The app will extract the `.txt` and parse numbers.</div>
      </section>

      <!-- Templates -->
      <section class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Templates</strong><div class="small muted">Save & apply</div></div>
          <div><button id="saveTemplate" class="btn">Save</button></div>
        </div>
        <div style="height:8px"></div>
        <input id="templateTitle" placeholder="Template title" />
        <div style="height:8px"></div>
        <textarea id="templateBody" placeholder="Template body..."></textarea>
        <div style="height:8px"></div>
        <div style="display:flex;gap:8px">
          <button id="applyTemplate" class="btn ghost">Apply to Campaign</button>
          <button id="loadFirstTemplate" class="btn ghost">Load first</button>
        </div>
      </section>

    </div>

    <!-- Right: attachments & prepared -->
    <div>

      <!-- Attachments -->
      <section class="card" id="attachmentsPanel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Attachments</strong><div class="small muted">Upload files (stored locally)</div></div>
          <div><input id="attachFileInput" type="file" /></div>
        </div>

        <div style="height:8px"></div>
        <div class="attachment-list" id="attachmentList" style="display:flex;gap:8px;flex-wrap:wrap"></div>

        <div style="height:8px"></div>
        <div class="small muted">Tip: after the chat opens, use the phone file picker to attach the file you downloaded from here.</div>
      </section>

      <!-- Prepared / send controls -->
      <section class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Prepare & Send</strong><div class="small muted">Choose send mode</div></div>
          <div>
            <label class="small muted">Gap (bulk ms) <input id="cfgBulkGap" type="number" min="0" value="2000" style="width:100px;margin-left:6px" /></label>
          </div>
        </div>

        <div style="height:8px"></div>
        <div class="row">
          <button id="sendAllBtn" class="btn">Send All at Once (bulk)</button>
          <button id="sendOneBtn" class="btn ghost">Send One-by-One (safe)</button>
          <button id="stopOneBtn" class="btn ghost" style="display:none">Stop</button>
        </div>

        <div style="height:8px"></div>
        <div id="preparedPreview" style="max-height:200px;overflow:auto"></div>
      </section>

    </div>
  </div>

  <div style="height:8px"></div>
  <div class="small muted">Note: this demo cannot auto-attach files to WhatsApp — it helps prepare, open chats and provide attachments for manual attach.</div>

  <button id="installBtn" class="fab" title="Install">Install</button>

</div>

<!-- One-by-One modal -->
<div id="oneModal" class="modal"><div class="panel card">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>One-by-One (auto-advance)</strong><div class="small muted">Auto-advance countdown when you return</div></div>
    <div><button id="closeOneModal" class="btn ghost">Close</button></div>
  </div>
  <div style="height:8px"></div>
  <div id="onePreparedList" style="max-height:50vh;overflow:auto"></div>
  <div style="height:10px"></div>
  <div style="display:flex;align-items:center;gap:8px">
    <div class="small muted">Countdown before next auto-open:</div>
    <div class="countdown" id="countdownDisplay">3</div>
    <div style="flex:1"></div>
    <button id="oneNextBtn" class="btn ghost">Next (open next)</button>
    <button id="oneStartBtn" class="btn">Start</button>
    <button id="oneStopBtn" class="btn ghost">Stop</button>
  </div>
</div></div>

<!-- JSZip CDN (required for .zip extraction) -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
/* WB Bulk Sender — single-file with ZIP import
   Key feature added: .zip handling using JSZip
*/

(async()=>{

/* IndexedDB helper for attachments */
function openDB(name='wb_db', version=1){
  return new Promise((res,rej)=>{
    const r = indexedDB.open(name, version);
    r.onupgradeneeded = e => {
      const db = e.target.result;
      if(!db.objectStoreNames.contains('attachments')) db.createObjectStore('attachments',{keyPath:'id'});
    };
    r.onsuccess = ()=> res(r.result);
    r.onerror = ()=> rej(r.error);
  });
}
async function putAttachment(obj){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx = db.transaction('attachments','readwrite');
    tx.objectStore('attachments').put(obj);
    tx.oncomplete = ()=> res(true);
    tx.onerror = ()=> rej(tx.error);
  });
}
async function getAllAttachments(){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx = db.transaction('attachments','readonly');
    const req = tx.objectStore('attachments').getAll();
    req.onsuccess = ()=> res(req.result || []);
    req.onerror = ()=> rej(req.error);
  });
}
async function deleteAttachment(id){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx = db.transaction('attachments','readwrite');
    tx.objectStore('attachments').delete(id);
    tx.oncomplete = ()=> res(true);
    tx.onerror = ()=> rej(tx.error);
  });
}

/* Small helpers */
const by = id => document.getElementById(id);
function escapeHtml(s){ if(!s) return ''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
const clamp = (v,min,max)=> Math.max(min, Math.min(max, v));

/* App state */
let store = {
  campaigns: JSON.parse(localStorage.getItem('wb_camps')||'[]'),
  templates: JSON.parse(localStorage.getItem('wb_templates')||'[]'),
  contacts: [] // {phone,name,selected}
};
function saveStore(){ localStorage.setItem('wb_camps', JSON.stringify(store.campaigns)); localStorage.setItem('wb_templates', JSON.stringify(store.templates)); }

/* Render contacts */
function renderContacts(){
  const tbody = document.querySelector('#contactsTable tbody');
  tbody.innerHTML = '';
  store.contacts.forEach((c,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="checkbox-col"><input type="checkbox" ${c.selected?'checked':''} data-i="${i}" class="selcb"></td>
                    <td>${escapeHtml(c.phone)}</td>
                    <td>${escapeHtml(c.name)}</td>
                    <td><button class="btn ghost" data-remove="${i}">Remove</button></td>`;
    tbody.appendChild(tr);
  });
}

/* Attachments list render */
let awaitAttachments = [];
async function loadAttachments(){ awaitAttachments = await getAllAttachments(); renderAttachments(); }
function renderAttachments(){
  const wrap = by('attachmentList'); wrap.innerHTML = '';
  (awaitAttachments || []).forEach(a=>{
    const div = document.createElement('div');
    div.style.display='flex'; div.style.flexDirection='column'; div.style.alignItems='center'; div.style.gap='6px';
    const img = document.createElement('img');
    img.src = a.dataUrl; img.alt=a.name;
    img.style.maxHeight='80px';
    const title = document.createElement('div'); title.className='small muted'; title.textContent = a.name;
    const btnRow = document.createElement('div'); btnRow.className='row';
    const dl = document.createElement('a'); dl.href = a.dataUrl; dl.download = a.name; dl.className='btn ghost'; dl.textContent='Download';
    const sel = document.createElement('button'); sel.className='btn'; sel.textContent='Use'; sel.onclick=()=>{ by('attachHint').value = a.name; alert('Attachment hint set to: ' + a.name + '. When chat opens, download this file to attach.'); };
    const del = document.createElement('button'); del.className='btn ghost'; del.textContent='Delete'; del.onclick=async()=>{ await deleteAttachment(a.id); await loadAttachments(); };
    btnRow.appendChild(dl); btnRow.appendChild(sel); btnRow.appendChild(del);
    div.appendChild(img); div.appendChild(title); div.appendChild(btnRow);
    wrap.appendChild(div);
  });
}

/* Parse lines into contacts (robust) */
function parseLinesToContacts(lines){
  lines.forEach(l=>{
    if(!l) return;
    let phone=''; let name='';
    if(l.includes(',')){
      const parts = l.split(',');
      phone = parts[0].replace(/[^0-9+]/g,'');
      name = parts.slice(1).join(',').trim();
    } else {
      const m = l.match(/(.*)<\\s*([+0-9\\-\\s]+)\\s*>/);
      if(m){ name = m[1].trim(); phone = m[2].replace(/[^0-9+]/g,''); }
      else {
        const p = l.match(/([+0-9]{6,})/);
        if(p){ phone = p[1].replace(/[^0-9+]/g,''); name = l.replace(p[1],'').replace(/[<>\"]/g,'').trim(); }
        else { name = l.trim(); phone = ''; }
      }
    }
    if(phone){
      // dedupe by phone
      const norm = phone.replace(/[^0-9]/g,'');
      if(!store.contacts.some(c=>c.phone.replace(/[^0-9]/g,'')===norm)) store.contacts.push({phone,name,selected:true});
    } else {
      if(!store.contacts.some(c=>c.name===name && !c.phone)) store.contacts.push({phone:'',name,selected:false});
    }
  });
  renderContacts();
}

/* Import handler (supports .zip via JSZip, .txt, .vcf, .csv) */
by('importBtn').addEventListener('click', async ()=>{
  const f = by('fileInput').files[0];
  if(!f){
    const paste = prompt('Paste list (or Cancel):','');
    if(paste){ parseLinesToContacts(paste.split(/\\r?\\n/)); alert('Imported from paste'); }
    return;
  }
  const fname = f.name.toLowerCase();
  if(fname.endsWith('.zip')){
    // handle zip using JSZip
    try{
      const ab = await f.arrayBuffer();
      const zip = await JSZip.loadAsync(ab);
      // find first .txt file inside (chat export)
      const txtFile = Object.keys(zip.files).find(k => k.toLowerCase().endsWith('.txt'));
      if(!txtFile){ alert('No .txt file found inside the ZIP'); return; }
      const content = await zip.file(txtFile).async('string');
      // attempt to extract numbers: split by lines
      const lines = content.split(/\\r?\\n/).map(s=>s.trim()).filter(Boolean);
      // Extract phone-like tokens from lines
      const tokens = [];
      lines.forEach(L=>{
        const found = L.match(/([+]?\\d[0-9\\-()\\s]{5,}\\d)/g);
        if(found) found.forEach(t=>tokens.push(t));
      });
      if(tokens.length===0){
        // fallback: treat lines as text and extract any digits
        const fallback = content.match(/([+]?\\d{6,})/g) || [];
        fallback.forEach(t=>tokens.push(t));
      }
      if(tokens.length===0){ alert('No phone numbers found inside exported text. Try exporting "without media" or copy the recipients and paste.'); return; }
      // dedupe and add
      const cleaned = Array.from(new Set(tokens.map(t=>t.replace(/[^0-9+]/g,''))));
      parseLinesToContacts(cleaned);
      alert('Parsed ' + cleaned.length + ' phone numbers from ZIP ('+txtFile+')');
      return;
    }catch(err){
      console.error(err);
      alert('Failed to read ZIP: ' + (err && err.message ? err.message : err));
      return;
    }
  } else if(fname.endsWith('.vcf')){
    // parse vcf
    const text = await f.text();
    const entries = text.split(/END:VCARD/i);
    const found = [];
    entries.forEach(entry=>{
      const mTel = entry.match(/TEL[^:]*:(.*)/i);
      if(mTel) found.push(mTel[1].replace(/[^0-9+]/g,''));
    });
    parseLinesToContacts(found);
    alert('Imported ' + found.length + ' from VCF');
    return;
  } else {
    // txt/csv
    const text = await f.text();
    const lines = text.split(/\\r?\\n/).map(s=>s.trim()).filter(Boolean);
    parseLinesToContacts(lines);
    alert('Imported ' + lines.length + ' lines from file');
    return;
  }
});

/* parse broadcast text manual paste */
by('parseBroadcastBtn').addEventListener('click', ()=>{
  const txt = prompt('Paste broadcast recipients text (copy from WhatsApp broadcast recipients view):','');
  if(!txt) return;
  const tokens = txt.split(/[,\\s\\n]+/).filter(Boolean);
  const phones = tokens.filter(t=>t.replace(/[^0-9+]/g,'').length>=6);
  phones.forEach(p=>{ const cleaned = p.replace(/[^0-9+]/g,''); if(!store.contacts.some(c=>c.phone.replace(/[^0-9]/g,'')===cleaned.replace(/[^0-9]/g,''))) store.contacts.push({phone:cleaned,name:'',selected:true}); });
  renderContacts();
  alert('Parsed ' + phones.length + ' numbers');
});

/* sample add */
by('addSample').addEventListener('click', ()=>{ store.contacts.push({phone:'919876543210',name:'Ravi',selected:true}); store.contacts.push({phone:'919812345678',name:'Anita',selected:true}); renderContacts(); });

/* remove / select events */
document.addEventListener('click', (e)=>{
  const rem = e.target.getAttribute('data-remove');
  if(rem!==null){ store.contacts.splice(Number(rem),1); renderContacts(); return; }
});
document.addEventListener('change', (e)=>{
  if(e.target.classList.contains('selcb')){ const i=Number(e.target.dataset.i); store.contacts[i].selected = e.target.checked; }
});
by('selectAll').addEventListener('change', (e)=>{ store.contacts.forEach(c=>c.selected=e.target.checked); renderContacts(); });

/* Templates & campaigns */
by('saveTemplate').addEventListener('click', ()=>{ const title = by('templateTitle').value.trim(); const body = by('templateBody').value; if(!title||!body){ alert('Template title+body required'); return; } store.templates.unshift({title,body}); saveStore(); alert('Template saved'); });
by('applyTemplate').addEventListener('click', ()=>{ if(store.templates[0]) by('campMessage').value = store.templates[0].body; else alert('No templates'); });
by('saveCampaign').addEventListener('click', ()=>{ const name = by('campName').value.trim(); if(!name){ alert('Campaign name required'); return; } const msg = by('campMessage').value; const data={name,message:msg,image:by('attachHint').value||''}; store.campaigns.unshift(data); saveStore(); alert('Campaign saved'); });

/* Prepare messages */
let prepared = []; // {phone,name,text}
function prepareMessages(){
  const name = by('campName').value.trim();
  const camp = store.campaigns.find(c=>c.name===name) || {name, message: by('campMessage').value, image: by('attachHint').value || ''};
  const recips = (camp.contacts && camp.contacts.length>0) ? camp.contacts : store.contacts.filter(c=>c.selected);
  const contacts = recips.filter(c=>c.phone && c.phone.replace(/\\D/g,'').length>6);
  prepared = contacts.map(ct=>{
    const text = (camp.message||'').replace(/{{\\s*name\\s*}}/ig, ct.name||'').replace(/\\r?\\n/g,'\\n');
    return {phone:ct.phone.replace(/[^0-9+]/g,''), name:ct.name, text};
  });
  const out = by('preparedPreview'); out.innerHTML = '';
  if(prepared.length===0) out.innerHTML = '<div class="small muted">No recipients prepared</div>';
  prepared.forEach((p,i)=>{
    const d = document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px solid rgba(255,255,255,0.02)';
    d.innerHTML = `<strong>${escapeHtml(p.name||p.phone)}</strong><div class="small muted">${escapeHtml(p.phone)}</div><pre style="white-space:pre-wrap">${escapeHtml(p.text)}</pre>`;
    out.appendChild(d);
  });
  return {prepared, imageHint: camp.image || ''};
}
by('previewBtn').addEventListener('click', ()=>{ prepareMessages(); alert('Preview updated below'); });
by('prepareSend').addEventListener('click', ()=>{ prepareMessages(); alert('Preview updated. Now use Send controls.'); });

/* Build WhatsApp url */
function buildWhatsappUrl(phone, text){
  const phoneNum = phone.replace(/[^0-9]/g,'');
  const encoded = encodeURIComponent(text||'');
  return 'https://api.whatsapp.com/send?phone=' + phoneNum + '&text=' + encoded;
}

/* Send All at Once (bulk) with 2s gap default (configurable) */
by('sendAllBtn').addEventListener('click', async ()=>{
  if(prepared.length===0){ alert('Nothing prepared. Click Prepare Send first.'); return; }
  const gap = clamp(Number(by('cfgBulkGap').value) || 2000, 0, 60000);
  if(!confirm('Open ' + prepared.length + ' chats, one every ' + gap + 'ms? Popups may be blocked.')) return;
  for(let i=0;i<prepared.length;i++){
    const p = prepared[i];
    window.open(buildWhatsappUrl(p.phone, p.text), '_blank');
    await new Promise(r => setTimeout(r, gap));
  }
  alert('Opened ' + prepared.length + ' chats. Attach files manually where needed and send.');
});

/* One-by-One with visibility detection + explicit countdown auto-advance */
let oneIndex = 0; let oneActive = false; let visCountdownTimer = null;
by('sendOneBtn').addEventListener('click', ()=> startOneModal());
by('oneStartBtn').addEventListener('click', ()=> startOneModal());
by('closeOneModal').addEventListener('click', ()=> { stopOne(); hideOneModal(); });
by('oneStopBtn').addEventListener('click', stopOne);
by('oneNextBtn').addEventListener('click', ()=>{ openNextOne(); });

function showOneModal(){ by('oneModal').style.display='flex'; }
function hideOneModal(){ by('oneModal').style.display='none'; }

function startOneModal(){
  const res = prepareMessages(); if(res.prepared.length===0){ alert('No recipients prepared'); return; }
  loadAttachments();
  const list = by('onePreparedList'); list.innerHTML='';
  prepared.forEach((p,i)=>{ const d = document.createElement('div'); d.style.padding='6px'; d.innerHTML = `<strong>${escapeHtml(p.name||p.phone)}</strong><div class="small muted">${escapeHtml(p.phone)}</div><pre style="white-space:pre-wrap">${escapeHtml(p.text)}</pre>`; list.appendChild(d); });
  oneIndex = 0; oneActive = true; showOneModal();
  document.removeEventListener('visibilitychange', visibilityHandler);
  document.addEventListener('visibilitychange', visibilityHandler);
}

function stopOne(){ oneActive = false; document.removeEventListener('visibilitychange', visibilityHandler); alert('One-by-One stopped'); }

async function openNextOne(){
  if(!oneActive) { alert('Not active'); return; }
  if(oneIndex >= prepared.length){ alert('Completed all recipients'); stopOne(); hideOneModal(); return; }
  const p = prepared[oneIndex++];
  const attachmentHint = by('attachHint').value;
  if(attachmentHint){ if(!confirm('Attach "'+attachmentHint+'" manually after chat opens, then send. Click OK to open chat for '+(p.name||p.phone))) { stopOne(); hideOneModal(); return; } }
  window.location.href = buildWhatsappUrl(p.phone, p.text);
}

/* visibility handler: when you return to browser, countdown then auto-open next */
function visibilityHandler(){
  if(!oneActive) return;
  if(document.visibilityState === 'visible'){
    let secs = Number(by('cfgCountdown').textContent) || 3;
    by('countdownDisplay').textContent = secs;
    if(visCountdownTimer) clearInterval(visCountdownTimer);
    visCountdownTimer = setInterval(()=>{
      secs--;
      by('countdownDisplay').textContent = secs;
      if(secs<=0){
        clearInterval(visCountdownTimer); visCountdownTimer=null;
        if(oneIndex < prepared.length) { openNextOne(); }
        else { alert('One-by-one complete'); stopOne(); hideOneModal(); }
      }
    }, 1000);
  } else {
    if(visCountdownTimer) { clearInterval(visCountdownTimer); visCountdownTimer=null; }
  }
}

/* Attachments upload */
by('attachFileInput').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = async (ev) => {
    const dataUrl = ev.target.result;
    const id = 'a_' + Date.now();
    await putAttachment({id, name: f.name, dataUrl});
    await loadAttachments();
    alert('Attachment uploaded and stored locally: ' + f.name + '. Use "Use" to set attach hint for campaign.');
  };
  reader.readAsDataURL(f);
});

/* initial load */
await loadAttachments();

/* PWA manifest & simple SW registration (dynamic blobs) */
function registerManifestAndSW(){
  const manifest = {
    name: "WB Bulk Sender (demo)",
    short_name: "WB Bulk",
    start_url: ".",
    display: "standalone",
    background_color: "#071025",
    theme_color: "#071025",
    icons: [{
      src: "data:image/svg+xml;base64," + btoa(`<svg xmlns='http://www.w3.org/2000/svg' width='192' height='192'><rect width='100%' height='100%' rx='32' fill='#0b84ff'/><text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-size='64' fill='white' font-family='sans-serif'>WB</text></svg>`),
      sizes: "192x192",
      type: "image/svg+xml"
    }]
  };
  const mf = new Blob([JSON.stringify(manifest)], {type:'application/json'});
  const mfurl = URL.createObjectURL(mf);
  let link = document.querySelector('link[rel="manifest"]');
  if(!link){ link = document.createElement('link'); link.rel='manifest'; document.head.appendChild(link); }
  link.href = mfurl;

  const swCode = `
    const CACHE_NAME = 'wb-pwa-cache-v1';
    const urlsToCache = ['./'];
    self.addEventListener('install', evt => {
      evt.waitUntil(caches.open(CACHE_NAME).then(cache=>cache.addAll(urlsToCache)).catch(()=>{}));
      self.skipWaiting();
    });
    self.addEventListener('activate', evt => { evt.waitUntil(self.clients.claim()); });
    self.addEventListener('fetch', evt => {
      if(evt.request.mode === 'navigate'){
        evt.respondWith(caches.match(evt.request).then(r=>r||fetch(evt.request)).catch(()=>fetch(evt.request)));
      }
    });
  `;
  const swBlob = new Blob([swCode], {type:'application/javascript'});
  const swUrl = URL.createObjectURL(swBlob);
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register(swUrl).then(()=> console.log('Service worker registered'));
  }
}
registerManifestAndSW();

/* install prompt handling */
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  deferredPrompt = e;
  by('installBtn').style.display = 'inline-block';
});
by('installBtn').addEventListener('click', async ()=>{
  if(deferredPrompt){
    deferredPrompt.prompt();
    const choice = await deferredPrompt.userChoice;
    console.log('install choice', choice);
  } else {
    alert('Use browser menu "Add to Home screen" to install.');
  }
});

/* save on exit */
window.addEventListener('beforeunload', ()=> saveStore());

/* initial render */
renderContacts();
renderAttachments();

})();
</script>
</body>
</html>
