<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>SHEIN Instant Watcher</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">

<style>
body { font-family: Arial; background:#f2f2f2; padding:10px }
h2 { text-align:center }
button {
  width:100%; padding:14px; margin:6px 0;
  font-size:16px; background:black; color:white; border:none;
}
.card {
  background:white; padding:10px; margin-top:8px;
  border-radius:6px;
}
.small { font-size:13px; color:#555 }
</style>
</head>

<body>

<h2>SHEIN Instant Watcher</h2>

<button onclick="toggle()">START / STOP AUTO SCAN</button>

<div id="status" class="card">Waiting…</div>
<div id="result"></div>

<audio id="beep">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">
</audio>

<script>
/* ================= SETTINGS ================= */
const allowedSizes = ["XL","L","28","30","32"];
const PINCODE = "248001";

/* ================= STATE ================= */
let running = false;
let interval = null;
let foundOnce = false;

/* ================= PERMISSIONS ================= */
if ("Notification" in window) {
  Notification.requestPermission();
}

/* ================= START / STOP ================= */
function toggle() {
  if (running) {
    clearInterval(interval);
    running = false;
    document.getElementById("status").innerText = "Stopped";
  } else {
    foundOnce = false;
    interval = setInterval(scan, 1000);
    running = true;
    document.getElementById("status").innerText =
      "Scanning every 1s | Pincode: " + PINCODE;
  }
}

/* ================= SCAN LOGIC ================= */
function scan() {
  if (foundOnce) return;

  let links = document.querySelectorAll("a");
  let groups = { "500": [], "1000": [], "4000": [] };

  links.forEach(a => {
    let text = a.innerText.toUpperCase();

    // Ignore out of stock
    if (
      text.includes("OUT OF STOCK") ||
      text.includes("SOLD OUT") ||
      text.includes("UNAVAILABLE")
    ) return;

    if (!text.includes("MEN")) return;

    let sizeOk = allowedSizes.some(s => text.includes(s));
    if (!sizeOk) return;

    let priceMatch = text.match(/₹\s?(\d+)/);
    if (!priceMatch) return;

    let price = parseInt(priceMatch[1]);
    let idMatch = a.href.match(/\d+/);
    if (!idMatch) return;

    let item = { id: idMatch[0], price };

    if (price <= 500) groups["500"].push(item);
    else if (price <= 1000) groups["1000"].push(item);
    else if (price <= 4000) groups["4000"].push(item);
  });

  if (groups["500"].length || groups["1000"].length || groups["4000"].length) {
    foundOnce = true;
    clearInterval(interval);
    alertUser(groups);
  }
}

/* ================= ALERT + UI ================= */
function alertUser(groups) {
  document.getElementById("beep").play();
  if (navigator.vibrate) navigator.vibrate([300,200,300]);

  if (Notification.permission === "granted") {
    new Notification("SHEIN Match Found", {
      body: "Products grouped by price"
    });
  }

  let html = "";
  html += renderGroup("≤ ₹500", groups["500"]);
  html += renderGroup("≤ ₹1000", groups["1000"]);
  html += renderGroup("≤ ₹4000", groups["4000"]);

  document.getElementById("result").innerHTML = html;
  document.getElementById("status").innerText =
    "Match found | Check delivery to " + PINCODE;
}

function renderGroup(title, items) {
  if (!items.length) return "";
  let html = `<div class="card"><b>${title}</b>`;
  items.slice(0,5).forEach(i => {
    html += `
      <button onclick="confirmOpen('${i.id}', ${i.price})">
        ₹${i.price} → OPEN IN SHEIN
      </button>`;
  });
  html += "</div>";
  return html;
}

function confirmOpen(id, price) {
  if (
    confirm(
      "Price: ₹" + price +
      "\nCheck delivery for pincode " + PINCODE +
      "?"
    )
  ) {
    window.location.href = "shein://product/" + id;
  }
}
</script>

<!-- ================= STEP 3 : PWA SCRIPT ================= -->
<script>
/* Service Worker */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("service-worker.js");
  });
}

/* Keep screen awake */
let wakeLock = null;
async function keepAwake() {
  try {
    if ("wakeLock" in navigator) {
      wakeLock = await navigator.wakeLock.request("screen");
    }
  } catch (e) {}
}
document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "visible") keepAwake();
});
keepAwake();
</script>

</body>
</html>
